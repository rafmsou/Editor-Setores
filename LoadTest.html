<!DOCTYPE HTML>
<html>
  <head>
    <script type="text/javascript" src="js/kinetic-v4.2.0.min.js"></script>
    <script type="text/javascript" src="js/jquery-1.8.3.js"></script>
    <script type="text/javascript" src="js/jquery-ui-1.9.2.custom.min.js"></script>
    <link rel="stylesheet" href="css/jquery-ui-1.9.2.custom.min.css" />
    <link rel="stylesheet" href="css/sector-editor.css" />
  </head>
  <body>
    <a class="linkBlue" href="javascript:loadJson()" alt="From Jason" title="From Jason">From Jason</a>
    <textarea id='txtJson' cols="150" rows="5"></textarea>

    <div id="container"></div>
    <script src="http://d3lp1msu2r81bx.cloudfront.net/kjs/js/lib/v4.2.0/kinetic-v4.2.0.js"></script>
    <script>
      var stage;

      function drawTooltip(tooltip, x, y, text) {
         tooltip.setText(text);
         var maxRight = 530;
         if(x > maxRight) {
           x = maxRight;
         }
         tooltip.setPosition(x, y);
         tooltip.show();
         tooltip.getLayer().draw();
      }

      function loadJson(){
        var json = $('#txtJson').val();

        // create node using json string
        stage = Kinetic.Node.create(json, 'container');

        // rebuilds the image
        var imageObj = new Image();
        imageObj.onload = function() {
          stage.get('.sectorsImage').apply('setImage', imageObj);
          stage.draw();
        };
        imageObj.src = 'images/layout-assentos.jpg';

        // rebuilds the sector hint
        var tooltipLayer = new Kinetic.Layer();
        var tooltip = new Kinetic.Text({
           text: '',
           textFill: 'white',
           fontFamily: 'Calibri',
           fontSize: 12,
           padding: 5,
           fill: 'black',
           visible: false,
           opacity: 0.75,
           listening: false
        });
        tooltipLayer.add(tooltip); 
        stage.add(tooltipLayer);

        stage.get('.section').on('mouseover', function() {
           var shape = this;
           shape.setOpacity(0.7);
           stage.draw();
        });
        stage.get('.section').on('mouseout', function() {
           var shape = this;
           shape.setOpacity(1);
           stage.draw();
           tooltip.hide();
           tooltipLayer.draw();
        });
        stage.get('.section').on('mousemove', function() {
           var shape = this;
           var mousePos = stage.getMousePosition();
           var x = mousePos.x + 15;
           var y = mousePos.y + 20;
           drawTooltip(tooltip, x, y, shape.attrs.sectionName);
        });
      }

    </script>
  </body>
</html>